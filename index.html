<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pupil LDT Task</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jsPsych core + CSS -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.1/css/jspsych.css" />
  <script src="https://unpkg.com/jspsych@7.3.1"></script>

  <!-- jsPsych plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script>

  <!-- SurveyJS-based jsPsych Survey plugin (ONE-PAGE questionnaire) -->
  <script src="https://unpkg.com/@jspsych/plugin-survey@1.0.1"></script>
  <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@1.0.1/css/survey.css">

  <!-- CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- DataPipe -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.5.0/dist/index.browser.min.js"></script>

  <!-- MEYE -->
  <script src="./vendor/plugin-meye-config.min.js"></script>
  <script src="./vendor/extension-meye.min.js"></script>

  <style>
    /* Middle grey background + black text */
    body {
      background-color: #808080;
      color: #000;
    }
    #jspsych-content {
      background-color: transparent;
      color: #000;
    }

    /* Word + fixation */
    .word {
      font-size: 64px;
      text-align: center;
      margin-top: 20vh;
      font-family: "Courier New", Courier, monospace;
      color: #000;
    }

    /* Consent: white, scrollable */
    .consent-box{
      background: #ffffff;
      color: #000000;

      max-width: 900px;
      margin: 0 auto;
      text-align: left;
      border: 1px solid #ccc;
      padding: 16px;

      height: 60vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>

<body>
<script>
/* ---------- init jsPsych ---------- */
const jsPsych = initJsPsych({
  show_progress_bar: true,
  auto_update_progress_bar: false,         // ✅ we will control it
  extensions: [{ type: jsPsychExtensionMeye }]
});

/* ---------- IDs / metadata ---------- */
const subject_id = jsPsych.randomization.randomID(10);
const filename = `${subject_id}.csv`;

jsPsych.data.addProperties({
  participant: subject_id,
  screenW: window.screen.availWidth,
  screenH: window.screen.availHeight,
  page_url: window.location.href
});

/* ---------- consent ---------- */
const consent = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="consent-box" id="consent-box">
      <h1>Boston College Department of Psychology</h1>
      <h2>Informed Consent to be in Study: Understanding Webcam Eye-tracking</h2>
      <p><strong>Researcher:</strong> Jason Geller, Ph.D.<br>
      <strong>Type of consent:</strong> Behavioral Consent Form</p>

      <h3>Introduction</h3>
      <p>
        You are being invited to take part in a research study that uses webcam-based eye-tracking
        to investigate how people process speech and language. The purpose of this study is to
        better understand how college-aged individuals perceive and interpret spoken language,
        and also gain insight into webcam eye-tracking more broadly. By tracking your eye
        movements using a webcam, we aim to gain insights into how visual attention supports
        language comprehension and information processing.
      </p>

      <h3>Who can participate?</h3>
      <p>
        You were selected to be in the study because you expressed interest in participating in
        cognitive psychology and neuroscience research in our laboratory, and because you meet the
        criteria for participation. In order to participate, participants must:
      </p>
      <ul>
        <li>Be 18–36 years old</li>
        <li>Be fluent in English</li>
        <li>Be able to see visual images on a computer screen</li>
        <li>Be able to hear auditory information</li>
      </ul>

      <h3>What will happen?</h3>
      <p>
        If you agree to take part in this research, you will be asked to complete a series of tasks
        involving speech sounds, words, or sentences while we track your eye movements on screen
        using the camera on the computer. The tasks may involve listening to speech and making
        decisions about what you hear by pressing a button, typing a response, clicking on buttons
        on screen, or looking at an item on screen. You will also be asked to fill out a questionnaire
        regarding your speech, language, and hearing experience and demographic information.
      </p>

      <h3>What is the time commitment?</h3>
      <p>
        The study is estimated to take 30 minutes to complete. The entire study will be conducted in one session.
      </p>

      <h3>How will we compensate you for being part of the study?</h3>
      <p>
        If you signed up through the psychological sciences participant pool (SONA), you will receive
        1 experimental credits upon completion.
      </p>

      <h3>What are the risks and benefits?</h3>
      <p>
        There may be no direct benefits to you, but you may feel gratified in knowing that you helped
        further scientific research. We hope that your participation in the study will tell us more about
        how listeners comprehend spoken language and how we can use webcams to study it.
      </p>
      <p>
        The risks of participating in this study are minimal. A possible discomfort is that you may feel
        fatigued. If you become upset or frustrated by the experiment, we encourage you to take breaks,
        and you can withdraw from the study at any time. There may be other risks that are unknown at
        this time. Choosing to be in this study is voluntary. If you choose not to be in this study, it will
        not affect your current or future relations with the University, and there is no penalty or loss of
        benefits. You are free to quit at any time, for whatever reason.
      </p>

      <h3>What will happen with your data?</h3>
      <p>
        All identifying data will be kept confidential. The research team will not be able to ascertain or
        have access to use and/or disclose subjects’ email addresses. The data will be stored on servers
        used to collect the data, including Gorilla (gorilla.sc) and/or Boston College web servers. They
        will be analyzed on password-protected computers in our lab or on secure Boston College servers.
      </p>
      <p>
        All data will include unique subject IDs generated by the recruitment site. Only individuals on an
        approved Research Personnel List will have access to this potentially identifying information.
        Subject IDs will be replaced with our own arbitrary numeric subject IDs before any data are shared
        with other researchers outside of our research team. This will further remove the shared data from
        the identifying information stored outside of our control on the recruitment site. No other identifying
        information will be requested as part of this study.
      </p>
      <p>
        Data that have been stripped of any identifying information may be shared with other researchers,
        who may use these data in their own research.
      </p>
      <p>
        <strong>Note:</strong> The Institutional Review Board at Boston College and internal Boston College auditors may
        review the research records. State or federal laws or court orders may also require that information
        from research study records be released. Otherwise, the researchers will not release to others any
        information that could indicate your identity unless you give your permission, or unless the researchers
        become legally required to do so.
      </p>

      <h3>Who can you contact if you have more questions?</h3>
      <ul>
        <li>If you have any questions or want more information concerning this research you may contact
          Dr. Jason Geller at <a href="mailto:gellerja@bc.edu">gellerja@bc.edu</a> or (515) 520-3464.</li>
        <li>If you have any questions about your rights as a person in this research study, you may contact:
          Director, Office for Research Protections, Boston College at (617) 552-4778, or
          <a href="mailto:irb@bc.edu">irb@bc.edu</a>.</li>
      </ul>

      <h3>Statement of Consent</h3>
      <p>By clicking “I Agree”:</p>
      <ul>
        <li>I agree to take part in this research.</li>
        <li>I verify that I am 18 or older.</li>
        <li>I feel like I understand what I am agreeing to.</li>
        <li>I know that I am free to withdraw at any time.</li>
      </ul>
    </div>

    <p style="max-width:900px;margin:12px auto 0;text-align:left;">
      Please scroll to the bottom of the consent form to enable “I Agree”.
    </p>
  `,
  choices: ["I Agree", "Do not agree"],
  on_load: () => {
    const btnAgree = document.querySelectorAll(".jspsych-btn")[0];
    const box = document.getElementById("consent-box");

    const update = () => {
      const needsScroll = box.scrollHeight > box.clientHeight + 2;
      if (!needsScroll) { btnAgree.disabled = false; return; }
      const atBottom = (box.scrollTop + box.clientHeight) >= (box.scrollHeight - 5);
      btnAgree.disabled = !atBottom;
    };

    btnAgree.disabled = true;
    setTimeout(update, 50);
    box.addEventListener("scroll", update);
    window.addEventListener("resize", update);
  },
  on_finish: d => { d.consent = (d.response === 0); }
};

const no_consent_end = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `<p>You chose not to participate. You may now close this window.</p>`,
  choices: "NO_KEYS",
  trial_duration: 2000
};

const welcome = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'Welcome to the Pupil experiment.<br><br>Press SPACE to start.',
  choices: [' ']
};

const meye_calibration = {
  type: jsPsychMeyeConfig
};

async function loadTrialsCSV(url) {
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`Failed to load ${url}: ${res.status}`);
  const text = await res.text();

  const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
  if (parsed.errors?.length) console.warn("CSV parse warnings:", parsed.errors);
  return parsed.data;
}

/* ---------- build + run AFTER loading trials ---------- */
(async () => {
  try {
    const rows = await loadTrialsCSV("./trials.csv");
    const trials = jsPsych.randomization.shuffle(rows);

    // Build your fixation+word trials
    const word_trials = trials.flatMap((t, i) => ([
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div class="word">+</div>`,
        choices: "NO_KEYS",
        trial_duration: 500,
        extensions: [{ type: jsPsychExtensionMeye, params: { detection_interval: 200 } }],
        data: { task: "fixation", trial_number: i + 1 }
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div class="word">${t.Target}</div>`,
        choices: ["z", "m"],
        extensions: [{ type: jsPsychExtensionMeye, params: { detection_interval: 200 } }],
        data: {
          task: "zm",
          freq: t.freq,
          Target: t.Target,
          lex: t.lex,
          correct_key: String(t.corrAns).toLowerCase(),
          trial_number: i + 1
        },
        on_finish: d => {
          d.correct = (String(d.response).toLowerCase() === String(d.correct_key).toLowerCase());
        }
      }
    ]));

    const task_instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p>You will see words.</p>
        <p>Press <b>Z</b> or <b>M</b>.</p>
        <p>Press space to start.</p>
      `,
      choices: [" "]
    };

    const end_questions = {
      type: jsPsychSurvey,
      survey_json: {
        showQuestionNumbers: "off",
        completeText: "Continue",
        elements: [
          { type: "text", name: "age", title: "What is your age?", isRequired: true, inputType: "number" },
          { type: "radiogroup", name: "gender", title: "What is your gender?", isRequired: true,
            choices: ["Female", "Male", "Nonbinary", "Prefer not to say"] },
          { type: "radiogroup", name: "english_fluent", title: "Are you fluent in English?", isRequired: true,
            choices: ["Yes", "No"] },
          { type: "radiogroup", name: "english_native", title: "Is English your native language?", isRequired: true,
            choices: ["Yes", "No"] },
          { type: "text", name: "native_language", title: "If English is not your native language, what is your native language?" },
          { type: "text", name: "english_start_age", title: "When did you start learning English? (age)" },
          { type: "text", name: "other_languages", title: "Do you speak other languages? List them here:" },
          { type: "radiogroup", name: "eye_color", title: "What is your eye color?", isRequired: true,
            choices: ["Brown", "Blue", "Green", "Hazel", "Gray", "Other / Mixed", "Prefer not to say"] },
          { type: "radiogroup", name: "vision_correction", title: "Do you normally wear glasses or contact lenses?",
            isRequired: true, choices: ["No", "Glasses", "Contact lenses", "Both"] },
          { type: "comment", name: "pupil_difficulty", title: "Was anything difficult about the pupil or eye tracking during the experiment?",
            placeholder: "e.g., lighting, glasses glare, head movement, webcam issues…" }
        ]
      },
      on_finish: (data) => {
        const r = data.response || {};
        jsPsych.data.addProperties({
          age: r.age,
          gender: r.gender,
          english_fluent: r.english_fluent,
          english_native: r.english_native,
          native_language: r.native_language,
          english_start_age: r.english_start_age,
          other_languages: r.other_languages,
          eye_color: r.eye_color,
          vision_correction: r.vision_correction,
          pupil_difficulty: r.pupil_difficulty
        });
      }
    };

    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "AA0OXBjnorxa",
      filename: filename,
      data_string: () => jsPsych.data.get().csv()
    };

    const end_screen = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>Thank you! You may now close this window.</p>`,
      choices: "NO_KEYS",
      trial_duration: 1500
    };

    /* ---------- ✅ MANUAL PROGRESS BAR WIRING ---------- */
    let progressCount = 0;

    // Count stages AFTER consent (consent itself is not counted here)
    const TOTAL_STEPS =
      1 + // welcome
      1 + // calibration
      1 + // instructions
      word_trials.length + // fixation + word (both count)
      1 + // end_questions
      1;  // end_screen

    const bumpProgress = (extraOnFinish) => (data) => {
      progressCount += 1;
      jsPsych.setProgressBar(progressCount / TOTAL_STEPS);
      if (typeof extraOnFinish === "function") extraOnFinish(data);
    };

    // start at 0
    jsPsych.setProgressBar(0);

    // Wrap on_finish for each stage we count
    welcome.on_finish = bumpProgress(welcome.on_finish);
    meye_calibration.on_finish = bumpProgress(meye_calibration.on_finish);
    task_instructions.on_finish = bumpProgress(task_instructions.on_finish);
    end_questions.on_finish = bumpProgress(end_questions.on_finish);
    end_screen.on_finish = bumpProgress(end_screen.on_finish);

    // Add on_finish to every fixation+word trial
    word_trials.forEach(tr => {
      tr.on_finish = bumpProgress(tr.on_finish);
    });
    /* ---------- ✅ END MANUAL PROGRESS ---------- */

    const timeline = [];
    timeline.push(consent);

    timeline.push({
      timeline: [no_consent_end],
      conditional_function: () => {
        const c = jsPsych.data.get().filter({ trial_type: "html-button-response" }).last(1).values()[0];
        return c && c.consent === false;
      }
    });

    timeline.push({
      timeline: [
        welcome,
        meye_calibration,
        task_instructions,
        ...word_trials,
        end_questions,
        save_data,
        end_screen
      ],
      conditional_function: () => {
        const c = jsPsych.data.get().filter({ trial_type: "html-button-response" }).last(1).values()[0];
        return c && c.consent === true;
      }
    });

    jsPsych.run(timeline);

  } catch (err) {
    console.error(err);
    document.body.innerHTML = `
      <div style="max-width:900px;margin:40px auto;font-family:system-ui, sans-serif;">
        <h2>Experiment failed to start</h2>
        <p><b>Error:</b> ${String(err).replaceAll("<","&lt;").replaceAll(">","&gt;")}</p>
        <p>Most common causes:</p>
        <ul>
          <li><code>trials.csv</code> is not in the same folder as <code>index.html</code></li>
          <li>File name capitalization mismatch (GitHub is case-sensitive)</li>
          <li>Opening the file as <code>file://</code> instead of via HTTPS/localhost</li>
        </ul>
      </div>
    `;
  }
})();
</script>
</body>
</html>
